#!/usr/bin/env bash

# Auto-activate uv virtual environment
if ! has uv; then
    echo "âŒ uv is not installed. Please install it first:"
    echo "   curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

# Create virtual environment if it doesn't exist
if [[ ! -d ".venv" ]]; then
    echo "ğŸ“¦ Creating virtual environment with uv..."
    uv venv
fi

# Activate the virtual environment
source .venv/bin/activate
# Source .envrc.local if present (for user/machine-specific settings)
if [[ -f ".envrc.local" ]]; then
    echo "ğŸ”’ Sourcing .envrc.local..."
    source .envrc.local
fi

# Sync dependencies (including dev dependencies)
echo "ğŸ”„ Syncing dependencies..."
uv sync --all-extras

# Install pre-commit hooks if they don't exist
if [[ -f ".pre-commit-config.yaml" ]] && ! uv run pre-commit --version >/dev/null 2>&1; then
    echo "ğŸª Installing pre-commit hooks..."
    uv run pre-commit install
fi

# Export environment variables
export PYTHONPATH="${PWD}/src:${PYTHONPATH}"
export UV_PROJECT_ENVIRONMENT="${PWD}/.venv"

echo "âœ… Environment activated!"
echo "ğŸ“ Virtual environment: ${VIRTUAL_ENV}"
echo "ğŸ Python: $(python --version)"
echo "ğŸ“¦ uv: $(uv --version)"

# Show available commands
echo ""
echo "ğŸš€ Available commands:"
echo "   uv run pytest                 # Run tests"
echo "   uv run pytest --cov           # Run tests with coverage report"
echo "   uv run ruff check             # Lint code"
echo "   uv run ruff format            # Format code"
